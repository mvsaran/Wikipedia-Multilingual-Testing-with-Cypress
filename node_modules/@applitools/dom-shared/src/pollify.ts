import poll = require('./poll')

function pollify(script: (...args: any[]) => any, context: Record<string, any>, key: string) {
  return (options?: any) =>
    function (...args: any[]) {
      if (!context[key]) {
        context[key] = {}
        Promise.resolve()
          .then(() => script(...args))
          .then(value => (context[key].value = value))
          .catch(err => (context[key].error = err.message + '\nStack:' + err.stack))
      }
      return poll(context, key, options)
    }
}

export = pollify
